---
// src/pages/editor.astro
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import "../styles/editor.css";
import { siteConfig } from "@/config";
// 确保 siteConfig.themeColor.hue 可用
const configHue = siteConfig.themeColor.hue;
---

<!doctype html>
<html
  lang="zh-CN"
  class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>编辑器 - Cr's Blog</title>

    <!-- Markdown Editor (Vditor) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/vditor@3.9.7/dist/index.css"
    />

    <!-- Set the theme before the page is rendered to avoid a flash -->
    <!-- 此部分仍需保留，因为它必须在其他脚本之前同步执行 -->
    <script is:inline>
      // Load the theme from local storage
      const savedTheme = localStorage.getItem("github_editor_theme");
      const systemPrefersDark = window.matchMedia(
        "(prefers-color-scheme: dark)"
      ).matches;
      const theme = savedTheme || (systemPrefersDark ? "dark" : "light");

      if (theme === "dark") {
        document.documentElement.classList.add("dark");
      }
    </script>

    <style define:vars={{ configHue }}>
      :root {
        --configHue: var(--configHue); /* 注入 configHue 为 CSS 变量 */
      }
    </style>
  </head>
  <!-- ... (Body Content remains the same) ... -->
  <body class="min-h-screen transition">
    <div id="app">
      <!-- Login View -->
      <div
        id="login-view"
        class="min-h-screen flex items-center justify-center p-4"
      >
        <div class="max-w-xl w-full card-base card-shadow p-8">
          <h2 class="text-2xl font-bold mb-6 text-90">GitHub 博客编辑器登录</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-75 mb-2">GitHub 用户名</label>
              <input
                id="github-user"
                type="text"
                placeholder="username"
                class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
              />
            </div>
            <div>
              <label class="block text-75 mb-2">GitHub 仓库名</label>
              <input
                id="github-repo"
                type="text"
                placeholder="例如 astro-blog"
                class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
              />
            </div>
            <div>
              <label class="block text-75 mb-2">个人访问令牌 (PAT)</label>
              <input
                id="github-pat"
                type="password"
                placeholder="粘贴您的 PAT"
                class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
              />
            </div>
            <div class="flex justify-end mt-6">
              <button
                id="login-btn"
                class="btn-regular px-6 py-2.5 rounded-lg font-medium flex items-center gap-2"
              >
                <span id="login-spinner" class="hidden">⏳</span>
                登录并加载文件
              </button>
            </div>
            <div id="login-error" class="text-red-500 mt-2 hidden text-sm">
            </div>
          </div>
        </div>
      </div>

      <!-- Main Editor View -->
      <div id="main-view" class="hidden p-4 md:p-8 min-h-screen">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-3xl font-bold text-90">博客文章编辑器</h1>
          <div class="flex items-center gap-4">
            <!-- Theme Toggle -->
            <button
              id="theme-toggle"
              class="btn-plain w-10 h-10 rounded-lg flex items-center justify-center"
            >
              <svg
                id="theme-icon-light"
                class="w-6 h-6 hidden"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"
                ></path>
              </svg>
              <svg
                id="theme-icon-dark"
                class="w-6 h-6"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"
                  clip-rule="evenodd"></path>
              </svg>
            </button>
            <button
              id="logout-btn"
              class="btn-regular px-4 py-2 rounded-lg text-sm font-medium"
            >
              登出
            </button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <!-- File List -->
          <div class="lg:col-span-1">
            <div class="card-base card-shadow p-6">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-90">文章列表</h2>
                <button
                  id="new-file-btn"
                  class="btn-regular px-3 py-1.5 rounded-lg text-sm font-medium"
                >
                  新建
                </button>
              </div>
              <div
                id="file-list-container"
                class="max-h-[calc(100vh-200px)] overflow-y-auto"
              >
                <ul id="file-list" class="space-y-1"></ul>
              </div>
            </div>
          </div>

          <!-- Editor Section -->
          <div id="editor-section" class="lg:col-span-3 hidden">
            <div class="card-base card-shadow p-6">
              <!-- Title and Rename Button -->
              <div class="flex items-center gap-3 mb-6">
                <h2 class="text-2xl font-bold text-90">
                  编辑: <span
                    id="current-file-name"
                    class="font-mono text-[var(--primary)]"></span>
                </h2>
                <button
                  id="rename-file-btn"
                  class="btn-plain px-3 py-1 rounded-md text-sm"
                >
                  重命名
                </button>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="block text-75 mb-2 text-sm">标题 (Title)</label>
                  <input
                    id="meta-title"
                    type="text"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
                  />
                </div>
                <div>
                  <label class="block text-75 mb-2 text-sm"
                    >类别 (Category)</label
                  >
                  <input
                    id="meta-category"
                    type="text"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
                  />
                </div>
                <div>
                  <label class="block text-75 mb-2 text-sm"
                    >发布日期 (Published)</label
                  >
                  <input
                    id="meta-published"
                    type="date"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
                  />
                </div>
                <div>
                  <label class="block text-75 mb-2 text-sm"
                    >更新日期 (Updated)</label
                  >
                  <input
                    id="meta-updated"
                    type="date"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
                  />
                </div>
                <div class="md:col-span-2">
                  <label class="block text-75 mb-2 text-sm"
                    >标签 (Tags, 用英文逗号分隔)</label
                  >
                  <input
                    id="meta-tags"
                    type="text"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
                  />
                </div>
                <div class="md:col-span-2">
                  <label class="block text-75 mb-2 text-sm"
                    >描述 (Description)</label
                  >
                  <textarea
                    id="meta-description"
                    class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition h-24 resize-none"
                  ></textarea>
                </div>
              </div>
              <!-- Vditor 结构 -->
              <div class="editor-container mb-6">
                <div id="markdown-editor"></div>
              </div>
              <div class="flex justify-between items-center mt-6">
                <button
                  id="delete-file-btn"
                  class="!text-red-500 btn-plain px-4 py-2 rounded-lg !hover:bg-red-500"
                >
                  删除文件
                </button>
                <div class="flex gap-3">
                  <button
                    id="test-output-btn"
                    class="btn-plain px-4 py-2 rounded-lg"
                  >
                    测试输出
                  </button>
                  <button
                    id="save-btn"
                    class="btn-regular px-4 py-2 rounded-lg font-medium flex items-center gap-2"
                  >
                    <span id="save-spinner" class="hidden">⏳</span>
                    保存更改
                  </button>
                </div>
              </div>
              <div id="save-status" class="mt-3 text-right text-sm"></div>
            </div>
          </div>

          <!-- Placeholder -->
          <div
            id="placeholder-section"
            class="lg:col-span-3 flex items-center justify-center"
          >
            <div class="text-center card-base card-shadow p-12">
              <p class="text-xl text-75">
                请从左侧选择一篇文章开始编辑，或新建一篇文章。
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- New File Modal -->
    <div
      id="new-file-modal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    >
      <div class="card-base card-shadow p-6 max-w-md w-full">
        <h3 class="font-bold text-lg text-90 mb-4">创建新文件</h3>
        <div class="mb-4">
          <label class="block text-75 mb-2 text-sm"
            >文件名 (例如 my-new-post)</label
          >
          <input
            id="new-filename-input"
            type="text"
            placeholder="请输入文件名"
            class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
          />
          <div id="new-file-error" class="text-red-500 mt-2 text-sm"></div>
        </div>
        <div class="flex justify-end gap-3">
          <button
            id="new-file-cancel-btn"
            class="btn-plain px-4 py-2 rounded-lg">取消</button
          >
          <button
            id="create-file-confirm-btn"
            class="btn-regular px-4 py-2 rounded-lg font-medium"
          >
            创建
          </button>
        </div>
      </div>
    </div>

    <!-- Rename File Modal -->
    <div
      id="rename-file-modal"
      class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"
    >
      <div class="card-base card-shadow p-6 max-w-md w-full">
        <h3 class="font-bold text-lg text-90 mb-4">重命名文件</h3>
        <div class="mb-4">
          <label class="block text-75 mb-2 text-sm"
            >新文件名 (不含 .md 后缀)</label
          >
          <input
            id="rename-filename-input"
            type="text"
            placeholder="请输入新文件名"
            class="w-full px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-90 border border-transparent focus:border-[var(--primary)] focus:outline-none transition"
          />
          <div id="rename-file-error" class="text-red-500 mt-2 text-sm"></div>
        </div>
        <div class="flex justify-end gap-3">
          <button
            id="rename-file-cancel-btn"
            class="btn-plain px-4 py-2 rounded-lg">取消</button
          >
          <button
            id="rename-file-confirm-btn"
            class="btn-regular px-4 py-2 rounded-lg font-medium"
          >
            确认重命名
          </button>
        </div>
      </div>
    </div>
    <!-- YAML Parser (js-yaml) -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"
    ></script>

    <!-- 导入并运行主客户端脚本 -->
    <script>
      import { initializeApp } from "../scripts/editor.ts";

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
